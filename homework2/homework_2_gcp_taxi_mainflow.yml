id: homework_2_gcp_taxi_mainflow
namespace: zoomcamp

variables:
  years: ["2019", "2020", "2021"]
  months: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"]

tasks:
  - id: green_taxi_data
    type: io.kestra.plugin.core.flow.ForEach
    values: "{{ vars.years }}"
    tasks:
      - id: for_each_month_green
        type: io.kestra.plugin.core.flow.ForEach
        values: "{{ vars.months }}"
        tasks:
          - id: call_subflow_green
            type: io.kestra.plugin.core.flow.Subflow
            runIf: "{{ not (parent.taskrun.value == '2021' and (taskrun.value == '08' or taskrun.value == '09' or taskrun.value == '10' or taskrun.value == '11' or taskrun.value == '12')) }}"
            namespace: zoomcamp
            flowId: homework_2_gcp_taxi_subflow
            wait: true
            transmitFailed: true
            inputs:
              taxi: "green"
              year: "{{ parent.taskrun.value }}"
              month: "{{ taskrun.value }}"

  - id: yellow_taxi_data
    type: io.kestra.plugin.core.flow.ForEach
    values: "{{ vars.years }}"
    tasks:
      - id: for_each_month_yellow
        type: io.kestra.plugin.core.flow.ForEach
        values: "{{ vars.months }}"
        tasks:
          - id: call_subflow_yellow
            type: io.kestra.plugin.core.flow.Subflow
            runIf: "{{ not (parent.taskrun.value == '2021' and (taskrun.value == '08' or taskrun.value == '09' or taskrun.value == '10' or taskrun.value == '11' or taskrun.value == '12')) }}"
            namespace: zoomcamp
            flowId: homework_2_gcp_taxi_subflow
            wait: true
            transmitFailed: true
            inputs:
              taxi: "yellow"
              year: "{{ parent.taskrun.value }}"
              month: "{{ taskrun.value }}"